<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FedxSmart - Dynamic Route Optimization Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    />
    <style>
      .dashboard-card {
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
      }
      .dashboard-card:hover {
        transform: translateY(-2px);
      }
      .metric-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }
      .green-card {
        background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
        color: white;
      }
      .orange-card {
        background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        color: white;
      }
      .red-card {
        background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
        color: white;
      }
      .map-container {
        height: 400px;
        border-radius: 15px;
        overflow: hidden;
      }
      .chart-container {
        height: 300px;
      }
      .navbar-brand {
        font-weight: bold;
        font-size: 1.5rem;
      }
      .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
      }
      .status-active {
        background-color: #4caf50;
      }
      .status-warning {
        background-color: #ff9800;
      }
      .status-error {
        background-color: #f44336;
      }

      .route-card {
        border-left: 4px solid #667eea;
        margin-bottom: 10px;
      }

      .comparison-table th {
        background-color: #f8f9fa;
        font-weight: 600;
      }

      .green-score {
        font-size: 2rem;
        font-weight: bold;
      }

      .loading-spinner {
        display: none;
      }
    </style>
  </head>
  <body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container">
        <a class="navbar-brand" href="#">
          <i class="fas fa-truck"></i> FedxSmart
        </a>
        <div class="navbar-nav ms-auto">
          <span class="navbar-text">
            <span class="status-indicator status-active"></span>
            System Active
          </span>
        </div>
      </div>
    </nav>

    <div class="container-fluid mt-4">
      <!-- Header -->
      <div class="row mb-4">
        <div class="col-12">
          <h2 class="text-primary">
            <i class="fas fa-chart-line"></i>
            Dynamic Route Optimization Dashboard
          </h2>
          <p class="text-muted">
            Real-time logistics intelligence and sustainability insights
          </p>
        </div>
      </div>

      <!-- Key Metrics Row -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card dashboard-card metric-card">
            <div class="card-body text-center">
              <i class="fas fa-route fa-2x mb-2"></i>
              <h3 id="total-routes">0</h3>
              <p class="mb-0">Routes Optimized</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card dashboard-card green-card">
            <div class="card-body text-center">
              <i class="fas fa-leaf fa-2x mb-2"></i>
              <h3 id="co2-saved">0 kg</h3>
              <p class="mb-0">CO₂ Emissions Saved</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card dashboard-card orange-card">
            <div class="card-body text-center">
              <i class="fas fa-clock fa-2x mb-2"></i>
              <h3 id="time-saved">0%</h3>
              <p class="mb-0">Time Savings</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card dashboard-card red-card">
            <div class="card-body text-center">
              <i class="fas fa-dollar-sign fa-2x mb-2"></i>
              <h3 id="cost-saved">$0</h3>
              <p class="mb-0">Cost Savings</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content Row -->
      <div class="row">
        <!-- Route Optimization Panel -->
        <div class="col-lg-6 mb-4">
          <div class="card dashboard-card">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0">
                <i class="fas fa-map-marked-alt"></i>
                Route Optimization
              </h5>
            </div>
            <div class="card-body">
              <form id="route-form">
                <div class="mb-3">
                  <label class="form-label">Origin</label>
                  <input
                    type="text"
                    class="form-control"
                    id="origin"
                    placeholder="Enter starting location"
                    value="40.7128,-74.0060"
                  />
                </div>
                <div class="mb-3">
                  <label class="form-label">Destinations</label>
                  <textarea
                    class="form-control"
                    id="destinations"
                    rows="3"
                    placeholder="Enter destinations (one per line)"
                  >
40.7589,-73.9851
40.6892,-74.0445
40.7505,-73.9934</textarea
                  >
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <label class="form-label">Vehicle Type</label>
                    <select class="form-select" id="vehicle-type">
                      <option value="diesel_truck">Diesel Truck</option>
                      <option value="electric_truck">Electric Truck</option>
                      <option value="hybrid_truck">Hybrid Truck</option>
                      <option value="hydrogen_truck">Hydrogen Truck</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Optimize For</label>
                    <select class="form-select" id="optimize-for">
                      <option value="time">Time</option>
                      <option value="distance">Distance</option>
                      <option value="fuel">Fuel Efficiency</option>
                      <option value="emissions">Emissions</option>
                    </select>
                  </div>
                </div>
                <button type="submit" class="btn btn-primary mt-3 w-100">
                  <i class="fas fa-cog"></i> Optimize Route
                </button>
              </form>

              <div class="loading-spinner mt-3 text-center">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Optimizing...</span>
                </div>
                <p class="mt-2">Optimizing route with real-time data...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Live Map -->
        <div class="col-lg-6 mb-4">
          <div class="card dashboard-card">
            <div class="card-header bg-success text-white">
              <h5 class="mb-0">
                <i class="fas fa-map"></i>
                Live Route Visualization
              </h5>
            </div>
            <div class="card-body p-0">
              <div id="map" class="map-container"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Results and Analytics Row -->
      <div class="row">
        <!-- Route Results -->
        <div class="col-lg-8 mb-4">
          <div class="card dashboard-card">
            <div class="card-header bg-info text-white">
              <h5 class="mb-0">
                <i class="fas fa-list-alt"></i>
                Optimization Results
              </h5>
            </div>
            <div class="card-body">
              <div id="route-results">
                <div class="text-center text-muted py-4">
                  <i class="fas fa-route fa-3x mb-3"></i>
                  <p>Click "Optimize Route" to see results</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Sustainability Metrics -->
        <div class="col-lg-4 mb-4">
          <div class="card dashboard-card">
            <div class="card-header bg-success text-white">
              <h5 class="mb-0">
                <i class="fas fa-leaf"></i>
                Sustainability Score
              </h5>
            </div>
            <div class="card-body text-center">
              <div class="green-score text-success" id="green-score">--</div>
              <p class="text-muted">Green Score (0-100)</p>

              <div class="mt-4">
                <h6>Environmental Impact</h6>
                <div class="row text-center">
                  <div class="col-6">
                    <small class="text-muted">CO₂ per km</small>
                    <div class="fw-bold" id="co2-per-km">-- kg</div>
                  </div>
                  <div class="col-6">
                    <small class="text-muted">Trees Needed</small>
                    <div class="fw-bold" id="trees-needed">--</div>
                  </div>
                </div>
              </div>

              <div class="mt-3">
                <div class="progress">
                  <div
                    class="progress-bar bg-success"
                    role="progressbar"
                    style="width: 0%"
                    id="green-progress"
                  ></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Scenario Analysis Row -->
      <div class="row">
        <div class="col-12 mb-4">
          <div class="card dashboard-card">
            <div class="card-header bg-warning text-dark">
              <h5 class="mb-0">
                <i class="fas fa-flask"></i>
                What-If Scenario Analysis
              </h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-4">
                  <h6>Traffic Scenarios</h6>
                  <button
                    class="btn btn-outline-primary btn-sm mb-2 scenario-btn"
                    data-scenario="peak_traffic"
                  >
                    Peak Traffic
                  </button>
                  <button
                    class="btn btn-outline-primary btn-sm mb-2 scenario-btn"
                    data-scenario="off_peak"
                  >
                    Off-Peak Hours
                  </button>
                </div>
                <div class="col-md-4">
                  <h6>Vehicle Alternatives</h6>
                  <button
                    class="btn btn-outline-success btn-sm mb-2 scenario-btn"
                    data-scenario="electric"
                  >
                    Electric Fleet
                  </button>
                  <button
                    class="btn btn-outline-info btn-sm mb-2 scenario-btn"
                    data-scenario="hybrid"
                  >
                    Hybrid Fleet
                  </button>
                </div>
                <div class="col-md-4">
                  <h6>Weather Conditions</h6>
                  <button
                    class="btn btn-outline-secondary btn-sm mb-2 scenario-btn"
                    data-scenario="rain"
                  >
                    Rainy Weather
                  </button>
                  <button
                    class="btn btn-outline-danger btn-sm mb-2 scenario-btn"
                    data-scenario="snow"
                  >
                    Snow Conditions
                  </button>
                </div>
              </div>

              <div id="scenario-results" class="mt-4" style="display: none">
                <h6>Scenario Impact Analysis</h6>
                <div class="table-responsive">
                  <table class="table table-sm comparison-table">
                    <thead>
                      <tr>
                        <th>Metric</th>
                        <th>Current</th>
                        <th>Scenario</th>
                        <th>Change</th>
                      </tr>
                    </thead>
                    <tbody id="scenario-comparison"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
      // Initialize map
      let map = L.map("map").setView([40.7128, -74.006], 11);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "© OpenStreetMap contributors",
      }).addTo(map);

      let currentRoute = null;
      let routeLayer = null;

      // Load dashboard data
      async function loadDashboardData() {
        try {
          const response = await fetch("/api/analytics/dashboard");
          const data = await response.json();

          // Update metrics
          document.getElementById("total-routes").textContent =
            data.summary?.total_routes || 0;
          document.getElementById("co2-saved").textContent = `${
            data.sustainability?.total_co2_saved_vs_baseline || 0
          } kg`;
          document.getElementById("time-saved").textContent = `${
            data.efficiency?.time_savings_vs_baseline || 0
          }%`;
          document.getElementById("cost-saved").textContent = `$${
            data.summary?.estimated_cost_usd || 0
          }`;
        } catch (error) {
          console.error("Failed to load dashboard data:", error);
        }
      }

      // Handle route optimization
      document
        .getElementById("route-form")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const loadingSpinner = document.querySelector(".loading-spinner");
          const resultsDiv = document.getElementById("route-results");

          loadingSpinner.style.display = "block";

          try {
            // Parse input data
            const origin = document.getElementById("origin").value.split(",");
            const destinationsText =
              document.getElementById("destinations").value;
            const destinations = destinationsText.split("\n").map((line) => {
              const coords = line.trim().split(",");
              return { lat: parseFloat(coords[0]), lng: parseFloat(coords[1]) };
            });

            const requestData = {
              origin: {
                lat: parseFloat(origin[0]),
                lng: parseFloat(origin[1]),
              },
              destinations: destinations,
              vehicle_type: document.getElementById("vehicle-type").value,
              preferences: {
                optimize_for: document.getElementById("optimize-for").value,
              },
            };

            const response = await fetch("/api/optimize-route", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(requestData),
            });

            const result = await response.json();
            currentRoute = result;

            // Display results
            displayRouteResults(result);
            displayRouteOnMap(result);
            updateSustainabilityMetrics(result.emissions);
          } catch (error) {
            console.error("Route optimization failed:", error);
            resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        Route optimization failed. Please try again.
                    </div>
                `;
          } finally {
            loadingSpinner.style.display = "none";
          }
        });

      function displayRouteResults(result) {
        const resultsDiv = document.getElementById("route-results");
        const metrics = result.optimization_metrics;

        resultsDiv.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-info-circle text-primary"></i> Route Summary</h6>
                        <ul class="list-unstyled">
                            <li><strong>Total Distance:</strong> ${
                              metrics.total_distance_km
                            } km</li>
                            <li><strong>Total Time:</strong> ${Math.round(
                              metrics.total_time_minutes
                            )} minutes</li>
                            <li><strong>Stops:</strong> ${
                              metrics.stops_count
                            }</li>
                            <li><strong>Average Speed:</strong> ${
                              metrics.average_speed_kmh
                            } km/h</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-chart-bar text-success"></i> Efficiency Metrics</h6>
                        <ul class="list-unstyled">
                            <li><strong>Fuel Consumed:</strong> ${
                              metrics.fuel_consumed_liters
                            } L</li>
                            <li><strong>Estimated Cost:</strong> $${
                              metrics.estimated_cost_usd
                            }</li>
                            <li><strong>Traffic Impact:</strong> ${Math.round(
                              (metrics.traffic_impact - 1) * 100
                            )}%</li>
                            <li><strong>Weather Impact:</strong> ${Math.round(
                              (metrics.weather_impact - 1) * 100
                            )}%</li>
                        </ul>
                    </div>
                </div>
                
                <div class="mt-3">
                    <h6><i class="fas fa-route text-info"></i> Optimized Route Sequence</h6>
                    <div class="route-sequence">
                        ${result.optimized_route.stops
                          .map(
                            (stop, index) => `
                            <div class="route-card card card-body py-2">
                                <small><strong>Stop ${index + 1}:</strong> 
                                ${stop.lat.toFixed(4)}, ${stop.lng.toFixed(4)}
                                ${
                                  stop.distance_from_previous
                                    ? `(${stop.distance_from_previous.toFixed(
                                        1
                                      )} km from previous)`
                                    : ""
                                }
                                </small>
                            </div>
                        `
                          )
                          .join("")}
                    </div>
                </div>
            `;
      }

      function displayRouteOnMap(result) {
        // Clear existing route
        if (routeLayer) {
          map.removeLayer(routeLayer);
        }

        const stops = result.optimized_route.stops;
        const coordinates = stops.map((stop) => [stop.lat, stop.lng]);

        // Add route line
        routeLayer = L.polyline(coordinates, {
          color: "blue",
          weight: 4,
        }).addTo(map);

        // Add markers
        stops.forEach((stop, index) => {
          const marker = L.marker([stop.lat, stop.lng]).addTo(map);
          marker.bindPopup(`Stop ${index + 1}<br>Sequence: ${stop.sequence}`);
        });

        // Fit map to route
        map.fitBounds(routeLayer.getBounds(), { padding: [20, 20] });
      }

      function updateSustainabilityMetrics(emissions) {
        if (!emissions) return;

        document.getElementById("green-score").textContent =
          emissions.green_score || "--";
        document.getElementById("co2-per-km").textContent = `${
          emissions.co2_per_km || 0
        } kg`;
        document.getElementById("trees-needed").textContent =
          emissions.equivalent_metrics?.trees_needed_per_year?.toFixed(1) ||
          "--";

        // Update progress bar
        const progressBar = document.getElementById("green-progress");
        progressBar.style.width = `${emissions.green_score || 0}%`;

        // Color code based on score
        if (emissions.green_score >= 80) {
          progressBar.className = "progress-bar bg-success";
        } else if (emissions.green_score >= 60) {
          progressBar.className = "progress-bar bg-warning";
        } else {
          progressBar.className = "progress-bar bg-danger";
        }
      }

      // Handle scenario analysis
      document.querySelectorAll(".scenario-btn").forEach((btn) => {
        btn.addEventListener("click", async function () {
          if (!currentRoute) {
            alert("Please optimize a route first");
            return;
          }

          const scenario = this.dataset.scenario;
          await runScenarioAnalysis(scenario);
        });
      });

      async function runScenarioAnalysis(scenarioType) {
        const scenarios = {
          peak_traffic: {
            name: "Peak Traffic",
            conditions: { traffic_multiplier: 1.5, time_of_day: "08:00" },
          },
          off_peak: {
            name: "Off-Peak Hours",
            conditions: { traffic_multiplier: 0.8, time_of_day: "22:00" },
          },
          electric: {
            name: "Electric Vehicle",
            conditions: { vehicle_type: "electric_truck" },
          },
          hybrid: {
            name: "Hybrid Vehicle",
            conditions: { vehicle_type: "hybrid_truck" },
          },
          rain: {
            name: "Rainy Weather",
            conditions: { weather_impact: "light_rain" },
          },
          snow: {
            name: "Snow Conditions",
            conditions: { weather_impact: "snow" },
          },
        };

        try {
          const response = await fetch("/api/scenario-analysis", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              base_route_id: currentRoute.route_id,
              scenarios: [scenarios[scenarioType]],
            }),
          });

          const result = await response.json();
          displayScenarioResults(result, scenarios[scenarioType].name);
        } catch (error) {
          console.error("Scenario analysis failed:", error);
        }
      }

      function displayScenarioResults(result, scenarioName) {
        const resultsDiv = document.getElementById("scenario-results");
        const comparisonBody = document.getElementById("scenario-comparison");

        if (!result.scenarios || Object.keys(result.scenarios).length === 0) {
          return;
        }

        const scenarioData = Object.values(result.scenarios)[0];
        const baseMetrics = result.base_metrics;
        const scenarioMetrics = scenarioData.modified_metrics;

        const metrics = [
          { key: "total_time_minutes", label: "Time (min)", unit: "" },
          { key: "total_distance_km", label: "Distance (km)", unit: "" },
          { key: "fuel_consumed_liters", label: "Fuel (L)", unit: "" },
          { key: "estimated_cost_usd", label: "Cost ($)", unit: "" },
        ];

        comparisonBody.innerHTML = metrics
          .map((metric) => {
            const baseValue = baseMetrics[metric.key] || 0;
            const scenarioValue = scenarioMetrics[metric.key] || 0;
            const change = scenarioValue - baseValue;
            const changePercent =
              baseValue > 0 ? ((change / baseValue) * 100).toFixed(1) : 0;
            const changeClass = change > 0 ? "text-danger" : "text-success";
            const changeIcon = change > 0 ? "fa-arrow-up" : "fa-arrow-down";

            return `
                    <tr>
                        <td>${metric.label}</td>
                        <td>${baseValue.toFixed(1)}</td>
                        <td>${scenarioValue.toFixed(1)}</td>
                        <td class="${changeClass}">
                            <i class="fas ${changeIcon}"></i>
                            ${Math.abs(change).toFixed(1)} (${Math.abs(
              changePercent
            )}%)
                        </td>
                    </tr>
                `;
          })
          .join("");

        resultsDiv.style.display = "block";
      }

      // Initialize dashboard
      loadDashboardData();

      // Refresh data every 30 seconds
      setInterval(loadDashboardData, 30000);
    </script>
  </body>
</html>
